version: 2.1
orbs:
  nodejs: circleci/node@1.1.4

commands:
  with-cargo-cache:
    parameters:
      steps:
        type: steps
      prefix:
        type: string
    steps:
      - run:
          name: Calculate dependencies
          command: |
            rustc --version >rust-version
            test -e Cargo.lock || cargo generate-lockfile
      - restore_cache:
          keys:
            - << parameters.prefix >>-cargo-cache-{{arch}}-{{checksum "rust-version"}}-{{checksum "Cargo.lock"}}
      - steps: << parameters.steps >>
      - save_cache:
          paths:
            - /usr/local/cargo/registry
            - target
          key: << parameters.prefix >>-cargo-cache-{{arch}}-{{checksum "rust-version"}}-{{checksum "Cargo.lock"}}

jobs:
  build:
    docker:
      - image: externalreality1/rust-web:latest

    steps:
      - checkout
      - with-cargo-cache:
          prefix: v9
          steps:
            - run:
                name: Cargo Web Check
                command: cargo web check
  test:
    docker:
      - image: externalreality1/rust-web:latest

    steps:
      - checkout

      - nodejs/with-cache:
           cache-version: v2
           steps:
             - run:
                 name: Install NodeJS Dependencies
                 command: npm install

      - with-cargo-cache:
          prefix: v10
          steps:
            - run:
                name: Run The Web Server
                command: cargo web start
                background: true

            - run:
                name: Wait for Web Server to Start
                command: |
                  apt install -y netcat
                  while ! echo exit | nc 127.0.0.1 8000; do sleep 10; done

            - run:
                name: Run The Tests
                command: |
                  TESTFILES=$(circleci tests glob "tests/**/*.js" | circleci tests split)
                  npm test -- $TESTFILES

            - store_test_results:
                path: tests_output

            - run:
                name: Build Release Directory
                command: cargo web deploy -o /tmp/deploy

      - persist_to_workspace:
          root: /tmp
          paths:
            - deploy

  acceptance_tests:
    docker:
     - image: circleci/ruby:2.4.2-jessie-node

    steps:
      - checkout

      - run:
          name: Run Acceptance tests
          command: echo "All Tests Passed"

  deploy:
  docker:
    - image: externalreality1/heroku-docker:latest

  environment:
    - DOCKER_BUILDKIT: '1'

  steps:
    - checkout

    - setup_remote_docker:
        version: 18.09.3

    - attach_workspace:
        at: .

    - run:
        name: Build Container
        command: |
          docker build -t web .

    - run:
        name: Deploy Container to Heroku
        command: |
          heroku container:login
          heroku container:push web --app $APP_NAME
          heroku container:release web --app $APP_NAME


workflows:
  build-and-deploy:
    jobs:
      - build

      - test:
          requires:
            - build

      - acceptance_tests:
          requires:
            - build

      - request_deploy:
          type: approval
          requires:
            - test
          filters:
            branches:
                only: master

      - deploy:
          requires:
            - request_deploy
